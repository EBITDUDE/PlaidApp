<!DOCTYPE html>
<html>
<head>
    <title>My Finance App</title>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
</head>
<body>
    <button id="link-button">Connect a Bank Account</button>
    <button id="transactions-button" style="display:none;">Get Transactions</button>
    <div id="transactions-output"></div>
    <div id="category-output"></div>

    <script>
    // Check if an access token exists on page load
    fetch('/has_access_token')
        .then(response => response.json())
        .then(data => {
            if (data.has_token) {
                document.getElementById('transactions-button').style.display = 'block';
            }
        });

    // Set up Plaid Link
    fetch('/create_link_token')
        .then(response => response.json())
        .then(data => {
            const handler = Plaid.create({
                token: data.link_token,
                onSuccess: (public_token, metadata) => {
                    fetch('/exchange_public_token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ public_token: public_token })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Access Token:', data.access_token);
                        alert('Bank account connected!');
                        document.getElementById('transactions-button').style.display = 'block';
                    });
                },
                onExit: (err, metadata) => {
                    console.log('User exited:', err);
                }
            });

            document.getElementById('link-button').onclick = () => {
                handler.open();
            };
        });

    // Fetch and display transactions and category totals
    document.getElementById('transactions-button').onclick = () => {
        fetch('/get_transactions')
            .then(response => response.json())
            .then(data => {
                const txOutput = document.getElementById('transactions-output');
                const catOutput = document.getElementById('category-output');
                if (data.error) {
                    txOutput.innerHTML = 'Error: ' + data.error;
                } else {
                    const transactions = data.transactions;
                    let txHtml = '<h2>Transactions</h2><ul>';
                    transactions.forEach(tx => {
                        txHtml += `<li>${tx.date}: ${tx.merchant} - $${tx.amount} (${tx.category})</li>`;
                    });
                    txHtml += '</ul>';
                    txOutput.innerHTML = txHtml;

                    const categories = data.category_totals;
                    let catHtml = '<h2>Category Totals</h2><ul>';
                    categories.forEach(cat => {
                        catHtml += `<li>${cat.category}: ${cat.total}</li>`;
                    });
                    catHtml += '</ul>';
                    catOutput.innerHTML = catHtml;
                }
            });
    };
    </script>
</body>
</html>